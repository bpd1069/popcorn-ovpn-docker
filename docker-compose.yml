version: '2'
services:
  vpn:
    container_name: vpn
    image: dceschmidt/openvpn-client
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    privileged: true
    restart: unless-stopped
    ports:
      - ${PROXY_PORT}:8888
    volumes:
      - /etc/localtime:/etc/localtime:ro
    environment:
      OPENVPN_PROVIDER: ${OPENVPN_PROVIDER}
      OPENVPN_USERNAME: ${OPENVPN_USERNAME}
      OPENVPN_PASSWORD: ${OPENVPN_PASSWORD}
      OPENVPN_CONFIG: ${OPENVPN_CONFIG}
      OPENVPN_OPTS: "--inactive 3600 --ping 10 --ping-exit 60"
  tinyproxy:
    container_name: tinyproxy
    image: vimagick/tinyproxy
    restart: unless-stopped
    network_mode: "service:vpn"
  popcorn:
    container_name: popcorn
    depends_on:
      - vpn
    network_mode: "service:vpn"
    build:
      context: ./popcorn
      args:
        USERNAME: ${USERNAME}
    mem_limit: 2G
    environment:
      DISPLAY: ${DISPLAY}
      XAUTHORITY: ${XAUTH}
      PULSE_SERVER: unix:/run/user/1000/pulse/native
    volumes:
      - ${POPCORN_CFG_DIR}:/home/${USERNAME}/.config/Popcorn-Time
      - ${POPCORN_TORRENTS_DIR}:/tmp/Popcorn-Time
      - ${XAUTH}:${XAUTH}
      - /tmp/.X11-unix:/tmp/.X11-unix
      - /run/user/1000/pulse:/run/user/1000/pulse
      - /var/run/dbus:/var/run/dbus
      - /dev/dri:/dev/dri
